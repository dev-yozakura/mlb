<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLB 投球 3D 軌道可視化</title>
    <script src="https://cdn.plot.ly/plotly-2.29.1.min.js" charset="utf-8"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        #plot-container {
            width: 100%;
            height: 800px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        #controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #34495e;
        }
        select, button {
            padding: 8px 12px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            background-color: white;
        }
        button {
            background-color: #3498db;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        #info-panel {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        #pitch-info {
            white-space: pre-wrap;
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            min-height: 50px;
        }
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #7f8c8d;
        }
        .error {
            background-color: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            margin: 20px 0;
        }
        #pitch-selector {
            margin: 20px 0;
            text-align: center;
        }
        #pitch-selector select {
            width: 300px;
            max-width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>⚾ MLB 投球 3D 軌道可視化</h1>
        
        <div id="controls">
            <div class="control-group">
                <label for="pitch-type-filter">球種フィルター</label>
                <select id="pitch-type-filter">
                    <option value="all">すべて</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="result-filter">結果フィルター</label>
                <select id="result-filter">
                    <option value="all">すべて</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="batter-hand-filter">打者利き手</label>
                <select id="batter-hand-filter">
                    <option value="all">すべて</option>
                    <option value="R">右</option>
                    <option value="L">左</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="reset-view">&nbsp;</label>
                <button id="reset-view">視点リセット</button>
            </div>
        </div>
        
        <div id="pitch-selector">
            <label for="pitch-select">表示する投球を選択:</label>
            <select id="pitch-select">
                <option value="">-- 投球を選択してください --</option>
            </select>
        </div>
        
        <div id="plot-container">
            <div class="loading">データを読み込んでいます...</div>
        </div>
        
        <div id="info-panel">
            <h3>選択した投球情報</h3>
            <div id="pitch-info">投球をクリックまたは選択して詳細を表示</div>
        </div>
    </div>

    <script>
        // グローバル変数
        let pitchData = [];
        let originalPitchData = [];
        let plotData = [];
        let currentPlotData = [];

        // カラーマップ（球種ごとの色）
        const colorMap = {
            'Four-Seam Fastball': '#e74c3c',
            'Sinker': '#c0392b',
            'Cutter': '#d35400',
            'Slider': '#f39c12',
            'Curveball': '#2980b9',
            'Changeup': '#27ae60',
            'Splitter': '#16a085',
            'Slurve': '#8e44ad',
            'Sweeper': '#3498db',
            'Knuckleball': '#95a5a6',
            'Other': '#7f8c8d'
        };

        // ゲームデータを取得して描画
        async function fetchAndProcessData() {
            const container = document.getElementById('plot-container');
            const gamePk = 776779;
            const url = `https://statsapi.mlb.com/api/v1.1/game/${gamePk}/feed/live`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                processAndPlotData(data);
            } catch (error) {
                container.innerHTML = `<div class="error">データの読み込みに失敗しました: ${error.message}</div>`;
                console.error("Error fetching game ", error);
            }
        }

        // データ処理とプロット
        function processAndPlotData(data) {
            const container = document.getElementById('plot-container');
            const allPlays = data.liveData.plays.allPlays || [];
            
            // 投球データを抽出
            allPlays.forEach((play, playIndex) => {
                const playEvents = play.playEvents || [];
                const batterSide = play.matchup?.batSide?.code || '不明';
                const pitcherHand = play.matchup?.pitchHand?.code || '不明';
                const playResult = play.result?.event || '不明';
                
                playEvents.forEach((event, eventIndex) => {
                    if (event.type === 'pitch' && event.pitchData && event.pitchData.coordinates) {
                        const coords = event.pitchData.coordinates;
                        const details = event.details || {};
                        const call = details.call || {};
                        const pitchType = details.type?.description || 'Other';
                        
                        // 有効な座標データがある場合のみ追加
                        if (coords.x != null && coords.y != null && coords.x0 != null && coords.y0 != null) {
                            pitchData.push({
                                x0: coords.x0,
                                y0: coords.y0,
                                z0: coords.z0 || 6.0, // リリースポイントの高さを標準的な6フィートに設定
                                x: coords.x,
                                y: coords.y,
                                z: 0, // プレートでのz座標は0とする
                                pX: coords.pX || 0,
                                pZ: coords.pZ || 0,
                                startSpeed: event.pitchData.startSpeed,
                                endSpeed: event.pitchData.endSpeed,
                                pitchType: pitchType,
                                result: call.description || '不明',
                                code: call.code || '不明',
                                batterSide: batterSide,
                                pitcherHand: pitcherHand,
                                playResult: playResult,
                                spinRate: event.pitchData.breaks?.spinRate || 'N/A',
                                spinDirection: event.pitchData.breaks?.spinDirection || 'N/A',
                                breakVertical: event.pitchData.breaks?.breakVertical || 'N/A',
                                breakHorizontal: event.pitchData.breaks?.breakHorizontal || 'N/A',
                                extension: event.pitchData.extension || 'N/A',
                                plateTime: event.pitchData.plateTime || 'N/A',
                                // 軌道を計算するために必要な追加パラメータ
                                vX0: coords.vX0 || 0,
                                vY0: coords.vY0 || 0,
                                vZ0: coords.vZ0 || 0,
                                aX: coords.aX || 0,
                                aY: coords.aY || 0,
                                aZ: coords.aZ || 0,
                                // 識別用のID
                                id: `${playIndex}-${eventIndex}`,
                                // ドロップダウン表示用のラベル
                                label: `${pitchType} (${call.description || '不明'}) - 打者: ${batterSide}`
                            });
                        }
                    }
                });
            });

            // 元のデータを保存
            originalPitchData = [...pitchData];
            
            // フィルターオプションを設定
            setupFilters();
            
            // ドロップダウンリストを設定
            setupPitchSelector();
            
            // プロットを描画（初期状態ではすべて表示）
            plot3DPitches();
        }

        // フィルターオプションを設定
        function setupFilters() {
            const pitchTypeFilter = document.getElementById('pitch-type-filter');
            const resultFilter = document.getElementById('result-filter');
            
            // 球種オプションを追加
            const pitchTypes = [...new Set(originalPitchData.map(p => p.pitchType))];
            pitchTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                pitchTypeFilter.appendChild(option);
            });
            
            // 結果オプションを追加
            const results = [...new Set(originalPitchData.map(p => p.result))];
            results.forEach(result => {
                const option = document.createElement('option');
                option.value = result;
                option.textContent = result;
                resultFilter.appendChild(option);
            });
            
            // フィルターイベントを設定
            pitchTypeFilter.addEventListener('change', applyFilters);
            resultFilter.addEventListener('change', applyFilters);
            document.getElementById('batter-hand-filter').addEventListener('change', applyFilters);
        }

        // ドロップダウンリストを設定
        function setupPitchSelector() {
            const pitchSelect = document.getElementById('pitch-select');
            
            // 既存のオプションをクリア
            pitchSelect.innerHTML = '<option value="">-- 投球を選択してください --</option>';
            
            // 投球データをドロップダウンに追加
            pitchData.forEach((pitch, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = pitch.label;
                pitchSelect.appendChild(option);
            });
            
            // イベントリスナーを設定
            pitchSelect.addEventListener('change', function() {
                const selectedIndex = this.value;
                if (selectedIndex !== '') {
                    displaySelectedPitch(selectedIndex);
                } else {
                    // すべての投球を表示
                    plot3DPitches();
                }
            });
        }

        // フィルターを適用
        function applyFilters() {
            const pitchTypeFilter = document.getElementById('pitch-type-filter').value;
            const resultFilter = document.getElementById('result-filter').value;
            const batterHandFilter = document.getElementById('batter-hand-filter').value;
            
            pitchData = originalPitchData.filter(pitch => {
                return (pitchTypeFilter === 'all' || pitch.pitchType === pitchTypeFilter) &&
                       (resultFilter === 'all' || pitch.result === resultFilter) &&
                       (batterHandFilter === 'all' || pitch.batterSide === batterHandFilter);
            });
            
            // ドロップダウンリストを更新
            setupPitchSelector();
            
            // プロットを再描画
            plot3DPitches();
        }

        // 投球軌道を計算（3次元放物線運動）
        function calculateTrajectory(pitch, numPoints = 50) {
            const x = [];
            const y = [];
            const z = [];
            
            // リリースポイント
            const x0 = pitch.x0;
            const y0 = pitch.y0;
            const z0 = pitch.z0;
            
            // 初速度
            const vx0 = pitch.vX0;
            const vy0 = pitch.vY0;
            const vz0 = pitch.vZ0;
            
            // 加速度
            const ax = pitch.aX;
            const ay = pitch.aY;
            const az = pitch.aZ;
            
            // プレート到達時間（仮に設定、実際のデータがあればそれを使う）
            const tMax = 0.5; // 仮の値、実際にはplateTimeを使う
            
            // 軌道を計算
            for (let i = 0; i <= numPoints; i++) {
                const t = (i / numPoints) * tMax;
                
                // 位置を計算 (等加速度運動の式)
                const xPos = x0 + vx0 * t + 0.5 * ax * t * t;
                const yPos = y0 + vy0 * t + 0.5 * ay * t * t;
                const zPos = z0 + vz0 * t + 0.5 * az * t * t;
                
                x.push(xPos);
                y.push(yPos);
                z.push(zPos);
            }
            
            return { x, y, z };
        }

        // 3Dプロットを描画
        function plot3DPitches() {
            const container = document.getElementById('plot-container');
            
            // データが空の場合
            if (pitchData.length === 0) {
                container.innerHTML = '<div class="loading">表示するデータがありません</div>';
                return;
            }
            
            // 各球種ごとにトレースを作成
            const pitchTypes = [...new Set(pitchData.map(p => p.pitchType))];
            plotData = [];
            
            pitchTypes.forEach(type => {
                const typePitches = pitchData.filter(p => p.pitchType === type);
                
                // 各投球の軌道を追加
                typePitches.forEach(pitch => {
                    // 軌道を計算
                    const trajectory = calculateTrajectory(pitch);
                    
                    // 軌道線用データ
                    const traceLine = {
                        type: 'scatter3d',
                        mode: 'lines',
                        x: trajectory.x,
                        y: trajectory.y,
                        z: trajectory.z,
                        line: {
                            width: 3,
                            color: colorMap[type] || '#7f8c8d'
                        },
                        name: type,
                        showlegend: false,
                        hoverinfo: 'none'
                    };
                    
                    plotData.push(traceLine);
                    
                    // リリースポイントとプレート到達点を表示
                    const tracePoints = {
                        type: 'scatter3d',
                        mode: 'markers',
                        x: [pitch.x0, pitch.x],
                        y: [pitch.y0, pitch.y],
                        z: [pitch.z0, pitch.z],
                        marker: {
                            size: [8, 10],
                            color: [colorMap[type] || '#7f8c8d', colorMap[type] || '#7f8c8d'],
                            opacity: [0.8, 1.0]
                        },
                        name: type,
                        text: [`リリースポイント (${type})`, `プレート到達点 (${type})`],
                        hovertemplate: '%{text}<extra></extra>',
                        showlegend: false
                    };
                    
                    plotData.push(tracePoints);
                });
            });
            
            // ホームプレートの可視化
            const plateTrace = {
                type: 'mesh3d',
                x: [120, 140, 140, 120, 120],
                y: [180, 180, 160, 160, 180],
                z: [0, 0, 0, 0, 0],
                opacity: 0.2,
                color: 'gray',
                showscale: false,
                name: 'ホームプレート',
                hoverinfo: 'skip'
            };
            
            plotData.push(plateTrace);
            
            // ストライクゾーンの可視化（簡略化）
            const strikeZoneTrace = {
                type: 'mesh3d',
                x: [120, 140, 140, 120, 120, 140, 140, 120],
                y: [180, 180, 180, 180, 160, 160, 160, 160],
                z: [1.5, 1.5, 3.5, 3.5, 3.5, 3.5, 1.5, 1.5],
                opacity: 0.1,
                color: 'blue',
                showscale: false,
                name: 'ストライクゾーン',
                hoverinfo: 'skip'
            };
            
            plotData.push(strikeZoneTrace);
            
            // レイアウト設定
            const layout = {
                title: '投球軌道 3D 可視化',
                scene: {
                    xaxis: {
                        title: '横方向 (inches)',
                        showgrid: true,
                        gridcolor: 'lightgray'
                    },
                    yaxis: {
                        title: '縦方向 (inches)',
                        showgrid: true,
                        gridcolor: 'lightgray'
                        // range: [0, 200] // 必要に応じて範囲を設定
                    },
                    zaxis: {
                        title: '高さ (feet)',
                        showgrid: true,
                        gridcolor: 'lightgray'
                    },
                    camera: {
                        eye: {x: 1.5, y: 1.5, z: 0.5}
                    },
                    aspectmode: 'manual',
                    aspectratio: {x: 1, y: 1, z: 0.5}
                },
                showlegend: true,
                legend: {
                    x: 0.8,
                    y: 0.9
                },
                margin: {
                    l: 0,
                    r: 0,
                    b: 0,
                    t: 50
                }
            };
            
            // コンフィグ設定
            const config = {
                responsive: true,
                displayModeBar: true
            };
            
            // プロットを描画
            Plotly.newPlot(container, plotData, layout, config).then(() => {
                // クリックイベントを追加
                container.on('plotly_click', function(data) {
                    if (data.points && data.points.length > 0) {
                        const point = data.points[0];
                        // カスタムデータがある場合は表示
                        if (point.customdata) {
                            displayPitchInfo(point.customdata);
                        }
                    }
                });
            });
            
            // 視点リセットボタンのイベント
            document.getElementById('reset-view').addEventListener('click', function() {
                const update = {
                    'scene.camera.eye': {x: 1.5, y: 1.5, z: 0.5}
                };
                Plotly.relayout(container, update);
            });
        }

        // 選択した投球のみを表示
        function displaySelectedPitch(index) {
            const container = document.getElementById('plot-container');
            const selectedPitch = pitchData[index];
            
            if (!selectedPitch) return;
            
            // 軌道を計算
            const trajectory = calculateTrajectory(selectedPitch);
            
            // 選択した投球のデータを作成
            const selectedPlotData = [];
            
            // 軌道線
            const traceLine = {
                type: 'scatter3d',
                mode: 'lines',
                x: trajectory.x,
                y: trajectory.y,
                z: trajectory.z,
                line: {
                    width: 6, // 太めの線で強調
                    color: colorMap[selectedPitch.pitchType] || '#7f8c8d'
                },
                name: selectedPitch.pitchType,
                showlegend: true
            };
            
            selectedPlotData.push(traceLine);
            
            // リリースポイントとプレート到達点
            const tracePoints = {
                type: 'scatter3d',
                mode: 'markers',
                x: [selectedPitch.x0, selectedPitch.x],
                y: [selectedPitch.y0, selectedPitch.y],
                z: [selectedPitch.z0, selectedPitch.z],
                marker: {
                    size: [10, 12],
                    color: [colorMap[selectedPitch.pitchType] || '#7f8c8d', colorMap[selectedPitch.pitchType] || '#7f8c8d'],
                    opacity: [1.0, 1.0]
                },
                name: `${selectedPitch.pitchType} ポイント`,
                text: [`リリースポイント`, `プレート到達点`],
                hovertemplate: '%{text}<extra></extra>'
            };
            
            selectedPlotData.push(tracePoints);
            
            // ホームプレート
            const plateTrace = {
                type: 'mesh3d',
                x: [120, 140, 140, 120, 120],
                y: [180, 180, 160, 160, 180],
                z: [0, 0, 0, 0, 0],
                opacity: 0.2,
                color: 'gray',
                showscale: false,
                name: 'ホームプレート',
                hoverinfo: 'skip'
            };
            
            selectedPlotData.push(plateTrace);
            
            // ストライクゾーン
            const strikeZoneTrace = {
                type: 'mesh3d',
                x: [120, 140, 140, 120, 120, 140, 140, 120],
                y: [180, 180, 180, 180, 160, 160, 160, 160],
                z: [1.5, 1.5, 3.5, 3.5, 3.5, 3.5, 1.5, 1.5],
                opacity: 0.1,
                color: 'blue',
                showscale: false,
                name: 'ストライクゾーン',
                hoverinfo: 'skip'
            };
            
            selectedPlotData.push(strikeZoneTrace);
            
            // レイアウト設定（選択モード用に調整）
            const layout = {
                title: `選択した投球: ${selectedPitch.pitchType}`,
                scene: {
                    xaxis: {
                        title: '横方向 (inches)',
                        showgrid: true,
                        gridcolor: 'lightgray'
                    },
                    yaxis: {
                        title: '縦方向 (inches)',
                        showgrid: true,
                        gridcolor: 'lightgray'
                    },
                    zaxis: {
                        title: '高さ (feet)',
                        showgrid: true,
                        gridcolor: 'lightgray'
                    },
                    camera: {
                        eye: {x: 1.5, y: 1.5, z: 0.5}
                    },
                    aspectmode: 'manual',
                    aspectratio: {x: 1, y: 1, z: 0.5}
                },
                showlegend: true,
                legend: {
                    x: 0.8,
                    y: 0.9
                },
                margin: {
                    l: 0,
                    r: 0,
                    b: 0,
                    t: 50
                }
            };
            
            // プロットを更新
            Plotly.newPlot(container, selectedPlotData, layout);
            
            // 投球情報を表示
            displayPitchInfo(selectedPitch);
        }

        // 投球情報を表示
        function displayPitchInfo(pitch) {
            const infoDiv = document.getElementById('pitch-info');
            infoDiv.innerHTML = `
球種: ${pitch.pitchType}
結果: ${pitch.result}
打者利き手: ${pitch.batterSide === 'R' ? '右' : pitch.batterSide === 'L' ? '左' : pitch.batterSide}
投手利き手: ${pitch.pitcherHand === 'R' ? '右' : pitch.pitcherHand === 'L' ? '左' : pitch.pitcherHand}
初速: ${pitch.startSpeed} mph
終速: ${pitch.endSpeed} mph
プレート位置: (${pitch.pX.toFixed(2)}, ${pitch.pZ.toFixed(2)})
回転数: ${pitch.spinRate} rpm
回転方向: ${pitch.spinDirection}°
縦のブレイク: ${pitch.breakVertical} inches
横のブレイク: ${pitch.breakHorizontal} inches
リリース距離: ${pitch.extension} feet
プレート到達時間: ${pitch.plateTime} 秒
            `.trim();
        }

        // ページ読み込み時に実行
        document.addEventListener('DOMContentLoaded', function() {
            fetchAndProcessData();
        });
    </script>
</body>
</html>