<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLB ストリーム プレーヤー</title>
    <style>
        /* ===== ダークモード / YouTube ライクなスタイル ===== */
        :root {
            --bg-primary: #0f0f0f; /* ページ背景 */
            --bg-secondary: #272727; /* コントロールパネル背景 */
            --bg-tertiary: #181818; /* プレーヤー背景 */
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --accent-color: #ff4444; /* アクセントカラー（赤） */
            --button-hover: #333333;
            --border-color: #303030;
            --success-color: #4CAF50;
            --warning-color: #FFC107;
            --error-color: #F44336;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding: 10px;
            min-height: 100vh;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* --- ヘッダー --- */
        .header {
            display: flex;
            flex-wrap: wrap; /* モバイル対応 */
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
            gap: 10px;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--accent-color);
            margin-right: 10px;
            flex-shrink: 0; /* ロゴが縮まないように */
        }

        .date-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .date-selector label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .date-input {
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }

        .btn-refresh {
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s ease;
        }

        .btn-refresh:hover {
            background-color: var(--button-hover);
        }

        .status-message {
            margin-left: auto;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .status-message.loading {
            background-color: var(--button-hover);
            color: var(--text-secondary);
        }
        .status-message.error {
            background-color: rgba(244, 67, 54, 0.2);
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }
        .status-message.success {
            background-color: rgba(76, 175, 80, 0.2);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }


        .search-bar {
            flex-grow: 1;
            padding: 8px 12px;
            border-radius: 2px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            min-width: 150px; /* 最小幅を設定 */
        }

        .user-actions {
            margin-left: 20px;
            color: var(--text-secondary);
            flex-shrink: 0; /* 縮まないように */
        }

        /* --- メインコンテンツ --- */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        @media (min-width: 992px) {
            .main-content {
                flex-direction: row;
            }
        }

        /* --- プレーヤーコンテナ --- */
        .player-section {
            flex: 1;
            min-width: 0; /* flexbox の子要素で overflow を防ぐ */
        }

        .video-wrapper {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 アスペクト比 */
            height: 0;
            background-color: var(--bg-tertiary); /* ロード中やエラー時の背景 */
            border-radius: 12px;
            overflow: hidden;
        }

        .video-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        .video-title {
            margin-top: 12px;
            font-size: 1.2rem;
            font-weight: 500;
        }

        .video-info {
            margin-top: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* --- コントロールパネル --- */
        .controls-section {
            width: 100%;
            background-color: var(--bg-secondary);
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
            max-height: 70vh; /* 高さ制限 */
            overflow-y: auto; /* 縦スクロール */
        }

        @media (min-width: 992px) {
            .controls-section {
                width: 350px;
                margin-top: 0;
                align-self: flex-start; /* 上揃え */
                height: fit-content; /* 高さを内容に合わせる */
                max-height: none; /* デスクトップでは高さ制限解除 */
                overflow-y: visible; /* スクロール解除 */
            }
        }

        .control-title {
            font-size: 1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stream-list {
            list-style: none;
        }

        .stream-item {
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: 1px solid transparent;
        }

        .stream-item:hover {
            background-color: var(--button-hover);
        }

        .stream-item.active {
            background-color: rgba(255, 68, 68, 0.1); /* 薄い赤背景 */
            border: 1px solid var(--accent-color);
        }

        .stream-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .stream-item-title {
            font-weight: 500;
            font-size: 0.95rem;
        }

        .stream-item-status {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            background-color: var(--button-hover);
        }
        .stream-item-status.live {
            background-color: rgba(255, 68, 68, 0.2);
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
        }
        .stream-item-status.final {
            background-color: rgba(76, 175, 80, 0.2);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .stream-item-teams {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .stream-item-team-away, .stream-item-team-home {
            display: flex;
            flex-direction: column;
            align-items: flex-end; /* デフォルトは右揃え */
        }
        .stream-item-team-home {
             align-items: flex-start; /* ホームチームは左揃え */
        }

        .stream-item-score {
            font-weight: bold;
        }

        .stream-item-venue {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

         /* ストリームリンクのスタイル */
        .stream-item-streams {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--border-color);
        }

        .stream-link {
            display: inline-block;
            margin: 3px 5px 3px 0;
            padding: 4px 8px;
            font-size: 0.75rem;
            text-decoration: none;
            color: var(--text-secondary);
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .stream-link:hover {
            background-color: var(--button-hover);
            color: var(--text-primary);
            border-color: var(--text-secondary);
        }

        /* 選択中のストリームリンクにスタイルを適用するには、
           JavaScriptで対応するリンクにクラスを追加するロジックが必要になります。
           例: renderStreamList 内で現在選択中のリンクに 'active-stream' クラスを付与 */
        .stream-link.active-stream {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        /* 詳細リンクのスタイル */
        .stream-item-details {
            margin-top: 8px;
            text-align: right; /* 右寄せ */
        }

        .detail-link {
            font-size: 0.8rem;
            color: #64B5F6; /* 明るい青 */
            text-decoration: none;
            border-bottom: 1px dotted #64B5F6;
        }

        .detail-link:hover {
            color: #90CAF9;
            border-bottom: 1px solid #90CAF9;
        }

        .no-games {
            color: var(--text-secondary);
            font-style: italic;
            text-align: center;
            padding: 20px 0;
        }


        /* --- ボトムナビゲーション (モバイル) --- */
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid var(--border-color);
            margin-top: 20px;
            display: none; /* デフォルトは非表示 */
        }

        @media (max-width: 991px) {
            .bottom-nav {
                display: flex;
            }
            /* モバイルではコントロールセクションを非表示にしない例 */
            /* .controls-section {
                display: none;
            } */
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.8rem;
        }

        .nav-item.active {
            color: var(--accent-color);
        }

        /* --- ボタン --- */
        .btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background-color: transparent;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.9rem;
            margin: 5px;
            transition: background-color 0.2s ease;
        }

        .btn:hover {
            background-color: var(--button-hover);
        }

        .btn-primary {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #cc3333; /* 少し暗い赤 */
            border-color: #cc3333;
        }

        /* --- フッター --- */
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* --- Play-by-Play スタイル --- */
        #play-by-play-container {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            max-height: 400px; /* 高さ制限 */
            overflow-y: auto; /* 縦スクロール */
        }

        .play-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        .play-item:last-child {
            border-bottom: none;
        }

        .play-atbat-index {
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 5px;
        }

        .play-description {
            margin-bottom: 5px;
        }

        .play-events-summary {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        #play-by-play-placeholder {
            color: var(--text-secondary);
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .loading-message, .error-message {
            padding: 10px;
            text-align: center;
            font-style: italic;
        }
        .loading-message {
            color: var(--text-secondary);
        }
        .error-message {
            color: var(--error-color);
        }
        /* --- ここまで --- */

/* --- games.css または <style> タグ内に追加 --- */

.stream-item-time {
    font-size: 0.85rem;
    color: var(--text-secondary); /* 他のセカンダリテキストと同様の色 */
    margin-bottom: 5px; /* チーム情報との間にスペース */
    text-align: center; /* 中央揃え (オプション) */
}
    </style>
</head>
<body>

<div class="app-container">
    <!-- ヘッダー -->
    <header class="header">
        <div class="logo">MLB TV</div>
        <div class="date-selector">
            <label for="game-date">Date:</label>
            <input type="date" id="game-date" class="date-input">
            <button id="refresh-btn" class="btn-refresh">Refresh</button>
        </div>
        <div id="status-message" class="status-message loading">Loading initial data...</div>
        <!-- <input type="text" class="search-bar" placeholder="Search for games..."> -->
        <!-- <div class="user-actions">Sign in</div> -->
    </header>

    <!-- メインコンテンツ -->
    <div class="main-content">
        <!-- プレーヤーセクション -->
        <section class="player-section">
            <div class="video-wrapper">
                <!-- 初期表示は空、またはプレースホルダー -->
                <iframe id="stream-frame"
                        src="about:blank" <!-- 初期は空 -->
                        allowfullscreen
                        allowtransparency
                        referrerpolicy="unsafe-url"
                        title="MLB Stream">
                </iframe>
            </div>
            <h2 class="video-title" id="stream-title">Select a game</h2>
            <div class="video-info" id="stream-info">No game selected</div>

             <div style="margin-top: 15px;">
                <button class="btn btn-primary">Subscribe</button>
                <button class="btn">Like</button>
                <button class="btn">Share</button>
            </div>

            <!-- --- 追加: Play-by-Play 表示領域 --- -->
            <div id="play-by-play-container">
                <h3 style="margin-top: 20px; padding-bottom: 5px; border-bottom: 1px solid var(--border-color);">Play-by-Play</h3>
                <div id="play-by-play-list">
                    <!-- ここにプレイが動的に追加される -->
                    <p id="play-by-play-placeholder">Select a game to load play-by-play data.</p>
                </div>
            </div>
            <!-- --- ここまで --- -->

        </section>

        <!-- コントロール / サイドバーセクション -->
        <aside class="controls-section">
            <div class="control-title">
                <span>Games</span>
                <span id="game-count">0</span>
            </div>
            <ul class="stream-list" id="stream-list">
                <!-- JavaScript で動的にリストアイテムを生成 -->
                <li class="no-games">Loading games...</li>
            </ul>
        </aside>
    </div>

    <!-- ボトムナビゲーション (モバイル) -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item active">Home</a>
        <a href="#" class="nav-item">Trending</a>
        <a href="#" class="nav-item">Subscriptions</a>
        <a href="#" class="nav-item">Library</a>
    </nav>

    <!-- フッター -->
    <footer class="footer">
        <p>&copy; 2025 MLB. All rights reserved. Officially licensed content.</p>
    </footer>
</div>

<script>
    // --- 設定 ---
    const MLB_API_BASE = 'https://statsapi.mlb.com/api/v1';
    const EMBED_BASE_URL = 'https://embedsports.me/mlb'; // 例に従う
    // --- ここから追加 ---
    const MLB_API_BASE_URL = 'https://statsapi.mlb.com'; // APIデータの完全URL作成用
    // --- ここまで ---
    // --- ユーティリティ関数 ---
    function formatDateForInput(dateObj) {
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dateObj.getDate()).padStart(2, '0');
        const year = dateObj.getFullYear();
        return `${year}-${month}-${day}`;
    }

    function formatDateForApi(dateObj) {
        // APIは MM/DD/YYYY 形式
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dateObj.getDate()).padStart(2, '0');
        const year = dateObj.getFullYear();
        return `${month}/${day}/${year}`;
    }

    function formatTeamNameForUrl(teamName) {
        // 例: "St. Louis Cardinals" -> "st-louis-cardinals"
        // まず "St." を "st" に置換
        let formattedName = teamName.replace(/St\./g, 'st');
        // その後、他のスペースをハイフンに置換し、小文字に変換
        formattedName = formattedName.toLowerCase().replace(/\s+/g, '-');
        return formattedName;
    }

    function generateEmbedUrl(homeTeamName, awayTeamName) {
        const homeSlug = formatTeamNameForUrl(homeTeamName);
        const awaySlug = formatTeamNameForUrl(awayTeamName);
        // 例に従って URL を構築
        return `${EMBED_BASE_URL}/${homeSlug}-vs-${awaySlug}-stream-1`;
    }

    function getGameStatusClass(detailedState) {
        if (detailedState.toLowerCase().includes('live') || detailedState.toLowerCase().includes('in progress')) {
            return 'live';
        } else if (detailedState.toLowerCase().includes('final')) {
            return 'final';
        }
        return ''; // その他 (Scheduled など)
    }

    function updateStatus(message, type = 'loading') {
        statusMessageElement.textContent = message;
        statusMessageElement.className = 'status-message ' + type;
    }

    // --- API呼び出しとデータ処理 ---
    async function fetchGames(dateStr) { // dateStr は MM/DD/YYYY
        const url = `${MLB_API_BASE}/schedule/games/?sportId=1&date=${dateStr}`;
        updateStatus(`Fetching games for ${dateStr}...`, 'loading');

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }
            const data = await response.json();
            console.log("Fetched ", data); // デバッグ用
            return data;
        } catch (error) {
            console.error("Error fetching games:", error);
            updateStatus(`Error: ${error.message}`, 'error');
            return null;
        }
    }

function processGamesData(data) {
    if (!data || !data.dates || data.dates.length === 0 || !data.dates[0].games) {
        updateStatus('No games data found.', 'error');
        return [];
    }

    const games = data.dates[0].games;
    const processedGames = games.map(game => {
        const homeTeam = game.teams.home.team;
        const awayTeam = game.teams.away.team;
        const status = game.status;

        const homeSlug = formatTeamNameForUrl(homeTeam.name);
        const awaySlug = formatTeamNameForUrl(awayTeam.name);
        const baseSlug = `${homeSlug}-vs-${awaySlug}`;

        const embedUrls = [];
        for (let i = 1; i <= 4; i++) {
            embedUrls.push(`${EMBED_BASE_URL}/${baseSlug}-stream-${i}`);
        }

        // --- 追加: ゲーム開始日時を保持 ---
        const gameDateUtc = game.gameDate; // ISO 8601 string (e.g., "2024-04-11T16:20:00Z")
        // --- 任意: ローカルタイムに変換 ---
        let gameDateLocal = null;
        if (gameDateUtc) {
            // Date オブジェクトに変換 (ブラウザのローカルタイムゾーンに自動調整)
            gameDateLocal = new Date(gameDateUtc);
        }
        // --- ここまで ---

        return {
            gamePk: game.gamePk,
            title: `${homeTeam.name} vs ${awayTeam.name}`,
            homeTeam: {
                name: homeTeam.name,
                score: game.teams.home.score !== undefined ? game.teams.home.score : '-'
            },
            awayTeam: {
                name: awayTeam.name,
                score: game.teams.away.score !== undefined ? game.teams.away.score : '-'
            },
            venue: game.venue ? game.venue.name : 'Unknown Venue',
            status: status.detailedState,
            statusCode: status.statusCode,
            embedUrls: embedUrls,
            baseSlug: baseSlug,
            detailLink: game.link,
            // --- 追加: 日時情報をオブジェクトに含める ---
            gameDateUtc: gameDateUtc,
            gameDateLocal: gameDateLocal
            // --- ここまで ---
        };
    });

    return processedGames;
}
    // --- UIレンダリング ---
    function renderStreamList(games) {
        streamListElement.innerHTML = ''; // 一旦クリア

        if (games.length === 0) {
            streamListElement.innerHTML = '<li class="no-games">No games scheduled for this date.</li>';
            gameCountElement.textContent = '0';
            return;
        }

        gameCountElement.textContent = games.length;

        // --- ゲームリストのソートロジックを追加 ---
        // 1. 'In Progress' または 'Live' のゲームを最上部に
        // 2. その他のゲームは元の順序（APIからの順序）を維持
        // (安定ソートを実現するために、元のインデックスも考慮)
        const sortedGames = [...games].sort((a, b) => {
            const isALive = a.status.toLowerCase().includes('progress') || a.status.toLowerCase().includes('live');
            const isBLive = b.status.toLowerCase().includes('progress') || b.status.toLowerCase().includes('live');

            if (isALive && !isBLive) {
                return -1; // a を b より前へ
            }
            if (!isALive && isBLive) {
                return 1;  // b を a より前へ
            }
            return 0; // 順序を変更しない (安定ソート)
        });
        // --- ここまで ---


       sortedGames.forEach(game => {
        const li = document.createElement('li');
        li.className = 'stream-item';
        if (game.gamePk === currentSelectedGamePk) {
            li.classList.add('active');
        }
        li.dataset.gamePk = game.gamePk;

        const statusClass = getGameStatusClass(game.status);

        let streamButtonsHtml = '';
        game.embedUrls.forEach((url, index) => {
            const streamNumber = index + 1;
            const isActiveStream = (game.gamePk === currentSelectedGamePk && index === currentSelectedStreamIndex);
            const activeClass = isActiveStream ? 'active-stream' : '';
            streamButtonsHtml += `<a href="#" class="stream-link ${activeClass}" data-stream-index="${index}">Stream ${streamNumber}</a> `;
        });

        let detailLinkHtml = '';
        if (game.detailLink) {
            const fullDetailUrl = `https://statsapi.mlb.com${game.detailLink}`;
            detailLinkHtml = `<a href="${fullDetailUrl}" target="_blank" rel="noopener noreferrer" class="detail-link">Details (New Tab)</a>`;
        }

        // --- 追加: 開始時間の文字列をフォーマット ---
        let gameTimeHtml = '';
        if (game.gameDateLocal) {
            // 簡単なフォーマット例 (例: "16:20" または "4:20 PM")
            // より高度なフォーマットには、Intl.DateTimeFormat やライブラリの使用を検討
            const hours = game.gameDateLocal.getHours().toString().padStart(2, '0');
            const minutes = game.gameDateLocal.getMinutes().toString().padStart(2, '0');
            // 12時間表示例 (オプション)
            // const hours12 = game.gameDateLocal.getHours() % 12 || 12;
            // const ampm = game.gameDateLocal.getHours() >= 12 ? 'PM' : 'AM';
            // gameTimeHtml = `<div class="stream-item-time">${hours12}:${minutes} ${ampm}</div>`;

            gameTimeHtml = `<div class="stream-item-time">${hours}:${minutes}</div>`;
        } else if (game.gameDateUtc) {
            // UTC時間のフォールバック表示 (例: "16:20 UTC")
             const utcDate = new Date(game.gameDateUtc);
             const hours = utcDate.getUTCHours().toString().padStart(2, '0');
             const minutes = utcDate.getUTCMinutes().toString().padStart(2, '0');
             gameTimeHtml = `<div class="stream-item-time">${hours}:${minutes} UTC</div>`;
        }

         // --- ここまで ---

        li.innerHTML = `
            <div class="stream-item-header">
                <div class="stream-item-title">${game.title}</div>
                <div class="stream-item-status ${statusClass}">${game.status}</div>
            </div>
            <!-- --- 追加: 開始時間をチーム情報の上に表示 --->
            ${gameTimeHtml}
            <!-- --- ここまで --->
            <div class="stream-item-teams">
                <div class="stream-item-team-away">
                    <span>${game.awayTeam.name}</span>
                    <span class="stream-item-score">${game.awayTeam.score}</span>
                </div>
                <div class="stream-item-team-home">
                    <span>${game.homeTeam.name}</span>
                    <span class="stream-item-score">${game.homeTeam.score}</span>
                </div>
            </div>
            <div class="stream-item-venue">${game.venue}</div>
            <div class="stream-item-streams">
                ${streamButtonsHtml}
            </div>
            <div class="stream-item-details">
                ${detailLinkHtml}
            </div>
        
            `;

            li.addEventListener('click', (event) => {
                // ストリームリンクがクリックされた場合は、そのリンクのイベントを処理
                if (event.target.classList.contains('stream-link')) {
                    event.preventDefault(); // リンクのデフォルト動作（ページ遷移）を防ぐ
                    const streamIndex = parseInt(event.target.dataset.streamIndex, 10);
                    selectStream(game.gamePk, streamIndex);
                } else {
                    // リストアイテム自体がクリックされた場合は、デフォルトストリーム（0番目）を選択
                    selectGame(game.gamePk);
                }
            });

            streamListElement.appendChild(li);
        });
    }

    // --- プレーヤー情報更新ロジック ---
    function updatePlayerInfo(selectedGame, streamIndex = 0) { // デフォルトは 0 (stream-1)
        if (selectedGame && selectedGame.embedUrls[streamIndex]) {
            titleElement.textContent = `${selectedGame.title} (Stream ${streamIndex + 1})`; // タイトルにストリーム番号を追加
            infoElement.textContent = `${selectedGame.status} • ${selectedGame.venue}`;
            // iframeのsrcを変更
            streamFrame.src = selectedGame.embedUrls[streamIndex];
        } else if (selectedGame) {
            // ゲーム情報はあるがストリームURLが無効
            titleElement.textContent = `${selectedGame.title} (Stream Unavailable)`;
            infoElement.textContent = `Stream ${streamIndex + 1} not available • ${selectedGame.venue}`;
            streamFrame.src = 'about:blank';
        } else {
            titleElement.textContent = 'Select a game';
            infoElement.textContent = 'No game selected';
            streamFrame.src = 'about:blank';
        }
    }

    // --- ゲーム選択ロジック（デフォルトストリーム） ---
    function selectGame(gamePk) {
        const selectedGame = currentGames.find(g => g.gamePk === gamePk);
        if (selectedGame) {
            // selectStream を呼び出すが、デフォルトは stream-1 (index 0)
            selectStream(gamePk, 0);
        }
    }

    // --- 特定ストリーム選択ロジック ---
    // streamIndex: 0 (stream-1), 1 (stream-2), ..., 3 (stream-4)
    function selectStream(gamePk, streamIndex) {
        if (gamePk === currentSelectedGamePk && streamIndex === currentSelectedStreamIndex) return;

        const selectedGame = currentGames.find(g => g.gamePk === gamePk);
        if (selectedGame && selectedGame.embedUrls[streamIndex]) {
            currentSelectedGamePk = gamePk;
            currentSelectedStreamIndex = streamIndex; // 新しい状態変数

            renderStreamList(currentGames); // アクティブ状態とストリーム選択状態を更新
            updatePlayerInfo(selectedGame, streamIndex); // プレーヤー情報を更新（ストリーム番号も渡す）
            updateStatus(`Playing: ${selectedGame.title} (Stream ${streamIndex + 1})`, 'success');
            
             // --- 追加: Play-by-Play データの読み込みを呼び出す ---
            // detailLink が存在する場合のみ読み込む
            if (selectedGame.detailLink) {
                loadAndDisplayPlayByPlay(selectedGame.gamePk, selectedGame.detailLink);
            } else {
                // detailLink がない場合の処理（念のため）
                const container = document.getElementById('play-by-play-list');
                container.innerHTML = '<p id="play-by-play-placeholder">Play-by-play data link not available for this game.</p>';
            }
            // --- ここまで ---

        } else if (selectedGame) {
             // ゲームは見つかったが、ストリームURLが無効
             updateStatus(`Stream ${streamIndex + 1} not available for this game.`, 'error');
             // エラー時もプレイバイプレイ領域をクリアまたはエラー表示
             const container = document.getElementById('play-by-play-list');
             container.innerHTML = '<div class="error-message">Cannot load play-by-play: Stream not available.</div>';
        }
    }

    // --- Play-by-Play データ取得・表示関数 ---
    async function loadAndDisplayPlayByPlay(gamePk, detailLink) {
        const container = document.getElementById('play-by-play-list');
        const placeholder = document.getElementById('play-by-play-placeholder');

        // 既存のプレイをクリア
        container.innerHTML = '';
        // ローディング表示
        const loadingElement = document.createElement('div');
        loadingElement.className = 'loading-message';
        loadingElement.textContent = 'Loading play-by-play data...';
        container.appendChild(loadingElement);

        try {
            // 1. 詳細データのURLを構築
            const fullDetailUrl = `${MLB_API_BASE_URL}${detailLink}`;
            console.log(`Fetching play-by-play data from: ${fullDetailUrl}`); // デバッグ

            // 2. APIからデータを取得
            const response = await fetch(fullDetailUrl);
            if (!response.ok) {
                throw new Error(`Failed to fetch play-by-play  ${response.status} ${response.statusText}`);
            }
            const gameData = await response.json();
            console.log("Fetched game data for play-by-play:", gameData); // デバッグ

            // 3. ローディング表示を削除
            container.innerHTML = '';

            // 4. データが有効かチェック
            if (!gameData.liveData || !gameData.liveData.plays || !Array.isArray(gameData.liveData.plays.allPlays)) {
                 const errorElement = document.createElement('div');
                 errorElement.className = 'error-message';
                 errorElement.textContent = 'Play-by-play data not available for this game.';
                 container.appendChild(errorElement);
                 return;
            }

            const allPlays = gameData.liveData.plays.allPlays;

            // 5. プレイを逆順（最新が上）で処理
            // allPlays は既に時系列順になっているが、表示上最新を上にしたい場合は逆順にする
            const sortedPlays = [...allPlays].reverse(); // 元の配列を変更しないようにコピー

            if (sortedPlays.length === 0) {
                 const placeholderElement = document.createElement('p');
                 placeholderElement.id = 'play-by-play-placeholder';
                 placeholderElement.textContent = 'No plays recorded yet.';
                 container.appendChild(placeholderElement);
                 return;
            }

            // 6. 各プレイを処理して表示
            sortedPlays.forEach(play => {
                const playElement = document.createElement('div');
                playElement.className = 'play-item';

                // 打席インデックス (例: "At Bat 5")
                const atBatIndexElement = document.createElement('div');
                atBatIndexElement.className = 'play-atbat-index';
                atBatIndexElement.textContent = `At Bat ${play.about.atBatIndex + 1}`; // APIは0始まりなので+1

                // プレイの結果説明 (例: "Trea Turner flies out to center fielder TJ Friedl.")
                const descriptionElement = document.createElement('div');
                descriptionElement.className = 'play-description';
                descriptionElement.textContent = play.result.description || 'No description';

                // 投球イベントの簡単なサマリー (例: "4 pitches: Ball, Strike, Foul, In play, out(s)")
                let eventsSummaryText = 'Events: ';
                if (play.playEvents && play.playEvents.length > 0) {
                    // 最後のN個（例: 3個）のイベントのみ表示するなど、調整可能
                    const eventDescriptions = play.playEvents.map(event =>
                        event.details && event.details.description ? event.details.description : 'Unknown event'
                    );
                    eventsSummaryText += eventDescriptions.join(', ');
                } else {
                    eventsSummaryText += 'No detailed events';
                }
                const eventsSummaryElement = document.createElement('div');
                eventsSummaryElement.className = 'play-events-summary';
                eventsSummaryElement.textContent = eventsSummaryText;

                playElement.appendChild(atBatIndexElement);
                playElement.appendChild(descriptionElement);
                playElement.appendChild(eventsSummaryElement);

                container.appendChild(playElement);
            });

        } catch (error) {
            console.error("Error loading play-by-play data:", error);
            // エラー表示を更新
            container.innerHTML = ''; // ローディング表示をクリア
            const errorElement = document.createElement('div');
            errorElement.className = 'error-message';
            errorElement.textContent = `Error loading play-by-play data: ${error.message}`;
            container.appendChild(errorElement);
        }
    }
    // --- ここまで ---


    // --- 初期化とイベント ---
    function initializeDate() {
        const today = new Date();
        gameDateInput.value = formatDateForInput(today);
    }

    async function loadGamesForSelectedDate() {
        const selectedDate = new Date(gameDateInput.value);
        const apiFormattedDate = formatDateForApi(selectedDate);

        const data = await fetchGames(apiFormattedDate);
        let games = processGamesData(data); // 一旦別の変数に格納

        if (games && games.length > 0) {
            // ソートは renderStreamList 内で行うので、ここでは不要
            // ただし、状態管理のためにソートされた配列を保存する
            // --- ゲームリストのソートロジックを追加 ---
            // 1. 'In Progress' または 'Live' のゲームを最上部に
            // 2. その他のゲームは元の順序（APIからの順序）を維持
            // (安定ソートを実現するために、元のインデックスも考慮)
            games.sort((a, b) => {
                const isALive = a.status.toLowerCase().includes('progress') || a.status.toLowerCase().includes('live');
                const isBLive = b.status.toLowerCase().includes('progress') || b.status.toLowerCase().includes('live');

                if (isALive && !isBLive) {
                    return -1; // a を b より前へ
                }
                if (!isALive && isBLive) {
                    return 1;  // b を a より前へ
                }
                return 0; // 順序を変更しない (安定ソート)
            });
            // --- ここまで ---

            currentGames = games; // ソート済みの配列を状態に保存

            renderStreamList(currentGames);
            // デフォルトで最初のゲームを選択
            if (currentSelectedGamePk === null) {
                 selectGame(currentGames[0].gamePk);
            } else {
                // 日付変更後も選択状態を維持しようとするが、同じgamePkがなければリセット
                const isSelectedGameStillAvailable = currentGames.some(g => g.gamePk === currentSelectedGamePk);
                if (!isSelectedGameStillAvailable) {
                     selectGame(currentGames[0].gamePk);
                } else {
                    // UIは更新、iframeは選択されたゲームに合わせる
                    renderStreamList(currentGames);
                    const selectedGame = currentGames.find(g => g.gamePk === currentSelectedGamePk);
                    updatePlayerInfo(selectedGame, currentSelectedStreamIndex); // ストリームインデックスも渡す
                     // プレイバイプレイも再ロード
                    if (selectedGame && selectedGame.detailLink) {
                         loadAndDisplayPlayByPlay(selectedGame.gamePk, selectedGame.detailLink);
                    }
                }
            }
            updateStatus(`Loaded ${currentGames.length} games for ${apiFormattedDate}`, 'success');
        } else {
            renderStreamList([]); // 空リストを表示
            updatePlayerInfo(null);
            currentSelectedGamePk = null;
            currentSelectedStreamIndex = 0; // ストリームインデックスもリセット
             // プレイバイプレイ領域もクリア
             const container = document.getElementById('play-by-play-list');
             container.innerHTML = '<p id="play-by-play-placeholder">No game selected or no data available.</p>';
            // updateStatusは processGamesData または fetchGames 内で設定済み
        }
    }

    // --- DOM要素の取得 ---
    const gameDateInput = document.getElementById('game-date');
    const refreshBtn = document.getElementById('refresh-btn');
    const statusMessageElement = document.getElementById('status-message');
    const streamFrame = document.getElementById('stream-frame');
    const titleElement = document.getElementById('stream-title');
    const infoElement = document.getElementById('stream-info');
    const streamListElement = document.getElementById('stream-list');
    const gameCountElement = document.getElementById('game-count');

    // --- 状態管理 ---
    let currentGames = [];
    let currentSelectedGamePk = null;
    let currentSelectedStreamIndex = 0; // 新しく追加: 選択中のストリームインデックス

    // --- イベントリスナー ---
    gameDateInput.addEventListener('change', loadGamesForSelectedDate);
    refreshBtn.addEventListener('click', loadGamesForSelectedDate);

    // --- アプリ開始 ---
    initializeDate();
    loadGamesForSelectedDate(); // 初期日付でゲームをロード

</script>

</body>
</html>